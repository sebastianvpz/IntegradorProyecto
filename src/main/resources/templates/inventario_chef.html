<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="_layout">
<head>
    <title>Inventario</title>
</head>
<body>
<div layout:fragment="content">
    <div id="vue-inventario">
        <h3 class="mb-4">Gestión de Inventario</h3>

        <!-- Filter and Actions -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <select class="form-select" v-model="filtroCategoria">
                    <option value="">Todas las categorías</option>
                    <option value="perecible">Perecible</option>
                    <option value="bebida">Bebida</option>
                    <option value="otro">Otro</option>
                </select>
                <button class="btn btn-success" @click="descargarExcel">
                    <i class="fas fa-file-excel"></i> Descargar
                </button>
            </div>
            <button class="btn btn-primary mt-2 mt-md-0" @click="abrirFormularioNuevo">
                <i class="fas fa-plus"></i> Agregar producto
            </button>
        </div>

        <!-- Table of Products -->
        <table class="table table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Cantidad</th>
                    <th>Vencimiento</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="producto in productosPaginados" :key="producto.id">
                    <td>{{ producto.nombre }}</td>
                    <td>{{ producto.categoria }}</td>
                    <td>{{ producto.cantidad }}</td>
                    <td>{{ producto.fechaVencimiento || '-' }}</td>
                    <td>
                        <!-- Action Buttons -->
                        <button class="btn btn-sm btn-success" @click="abrirModalSolicitar(producto)">Solicitar</button>
                        <button class="btn btn-sm btn-warning" @click="abrirModalUsar(producto)">Usar</button>
                        <button class="btn btn-sm btn-info" @click="editarProducto(producto)">Editar</button>
                        <button class="btn btn-sm btn-danger" @click="inactivarProducto(producto.id)">Inactivar</button>
                    </td>
                </tr>
                <tr v-if="productosPaginados.length === 0">
                    <td colspan="5" class="text-center">No se encontraron productos.</td>
                </tr>
            </tbody>
        </table>

        <!-- Confirm Action Modal -->
        <div class="modal fade" id="modalConfirmar" tabindex="-1" aria-labelledby="modalConfirmarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalConfirmarLabel">Confirmar Informe</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Summary of actions -->
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="producto in productosSeleccionados" :key="producto.id">
                                    <td>{{ producto.nombre }}</td>
                                    <td>{{ producto.cantidad }}</td>
                                    <td>{{ producto.accion }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" @click="confirmarInforme">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" :class="{ disabled: paginaActual === 1 }">
                    <a class="page-link" href="#" @click.prevent="paginaActual--">Anterior</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">{{ paginaActual }} / {{ totalPaginas }}</span>
                </li>
                <li class="page-item" :class="{ disabled: paginaActual === totalPaginas }">
                    <a class="page-link" href="#" @click.prevent="paginaActual++">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<script>
    new Vue({
        el: '#vue-inventario',
        data() {
            return {
                productos: [], // Lista completa de productos
                productosPaginados: [], // Productos que se muestran en la página actual
                filtroCategoria: '', // Filtro para las categorías
                paginaActual: 1, // Página actual para paginación
                totalPaginas: 1, // Total de páginas
                productosSeleccionados: [], // Productos seleccionados para el informe
            };
        },
        methods: {
            // Cargar productos (simulación con datos estáticos, reemplazar con API en producción)
            cargarProductos() {
                axios.get('/api/productos') // Suponiendo que tienes una API para obtener los productos
                    .then(response => {
                        this.productos = response.data;
                        this.totalPaginas = Math.ceil(this.productos.length / 10);
                        this.productosPaginados = this.productos.slice(0, 10); // Mostrar primeros 10
                    });
            },
            // Abrir modal para solicitar producto
            abrirModalSolicitar(producto) {
                let cantidadSolicitada = prompt(`Ingrese cantidad para solicitar el producto ${producto.nombre}`);
                if (cantidadSolicitada) {
                    this.productosSeleccionados.push({ ...producto, cantidad: cantidadSolicitada, accion: 'Solicitar' });
                }
            },
            // Abrir modal para usar producto
            abrirModalUsar(producto) {
                let cantidadUsada = prompt(`Ingrese cantidad para usar el producto ${producto.nombre}`);
                if (cantidadUsada) {
                    this.productosSeleccionados.push({ ...producto, cantidad: cantidadUsada, accion: 'Usar' });
                }
            },
            // Confirmar la solicitud o uso de los productos
            confirmarInforme() {
                // Enviar los datos al backend
                axios.post('/api/informes', { productos: this.productosSeleccionados })
                    .then(response => {
                        alert('Informe confirmado');
                        this.productosSeleccionados = []; // Limpiar selección
                    });
            },
            // Descargar productos en un archivo Excel
            descargarExcel() {
                axios.get('/api/productos/excel', { responseType: 'blob' })
                    .then(response => {
                        const url = window.URL.createObjectURL(new Blob([response.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', 'inventario.xlsx');
                        document.body.appendChild(link);
                        link.click();
                    });
            },
            // Editar producto (función básica, debe abrir un modal o algo similar)
            editarProducto(producto) {
                alert('Editar producto: ' + producto.nombre);
            },
            // Inactivar producto
            inactivarProducto(productoId) {
                axios.put(`/api/productos/inactivar/${productoId}`)
                    .then(response => {
                        alert('Producto inactivado');
                        this.cargarProductos(); // Recargar productos
                    });
            },
        },
        created() {
            this.cargarProductos(); // Cargar productos al iniciar
        }
    });
</script>
</body>
</html>
