<html layout:decorate="_layout">
    <head>
        <title>Nuevo Pedido</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <style>
            .producto-card {
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px 12px;
                margin-bottom: 10px;
                background: #fff;
                font-size: 14px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                height: 150px;
            }
            .producto-card p {
                margin: 0;
                line-height: 1.4;
            }
            .producto-card .producto-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .producto-card .producto-info {
                flex-grow: 1;
            }
            .producto-card .producto-agregar {
                margin-top: 8px;
            }
            .pedido-panel {
                border: 1px solid #ccc;
                border-radius: 10px;
                padding: 20px;
                background: #fefefe;
                height: 100%;
            }
            .pedido-panel h5 {
                font-weight: bold;
            }
            .scroll-productos {
                max-height: 600px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <div layout:fragment="content" class="container-fluid" id="app">
            <!-- panel izquierdo -->
            <div class="row">
                <div class="col-md-8">
                    <!-- buscador -->
                    <div class="mb-3 d-flex align-items-center">
                        <a href="/pedidos" class="btn btn-danger me-3">‚Üê Volver</a>
                        <input type="text" placeholder="Buscar plato" class="form-control w-50 me-2" v-model="busqueda">
                        <button class="btn btn-light"><i class="bi bi-search"></i></button>
                    </div>
                    <div class="row scroll-productos">
                        <div class="col-md-6 mb-3" v-for="p in platosFiltrados" :key="p.id">
                            <div class="producto-card">
                                <div class="producto-header">
                                    <strong>{{ p.nombre }}</strong>
                                    <span class="text-success">S/ {{ p.precio.toFixed(2) }}</span>
                                </div>
                                <div class="producto-info mt-1">
                                    <small>{{ p.descripcion || 'Sin descripci√≥n' }}</small>
                                </div>
                                <div class="producto-agregar">
                                    <button class="btn btn-sm btn-dark w-100" @click="agregarPlato(p)">Agregar +</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="pedido-panel">
                        <div class="mb-3">
                            <label for="nombreCliente" class="form-label">Nombre del comensal:</label>
                            <input type="text" id="nombreCliente" class="form-control mb-2"
                                   v-model="nombreCliente" placeholder="Ingrese nombre del comensal">

                            <label for="numeroMesa" class="form-label">N√∫mero de mesa:</label>
                            <input type="number" id="numeroMesa" class="form-control mb-2"
                                   v-model.number="numeroMesa" min="1" placeholder="Ej. 5">

                            <label for="personas" class="form-label">N√∫mero de personas:</label>
                            <input type="number" id="personas" class="form-control"
                                   v-model.number="personas" min="1">
                        </div>
                        <table class="table table-sm table-bordered">
                            <thead class="table-info">
                                <tr>
                                    <th>Plato</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in pedido" :key="item.id">
                                    <td>{{ item.nombre }}</td>
                                    <td>{{ item.cantidad }}</td>
                                    <td>{{ (item.precio * item.cantidad).toFixed(2) }}/S</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" @click="quitarPlato(item)">üóë</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mb-2">
                            <select class="form-select d-inline w-50" v-model="tipoDescuento">
                                <option>Porcentaje</option>
                                <option>Fijo</option>
                            </select>
                            <input type="number" class="form-control d-inline w-25 ms-2"
                                   placeholder="Descuento" v-model.number="valorDescuento">
                            <button class="btn btn-secondary ms-2" @click="aplicarDescuento">Aplicar</button>
                        </div>
                        <div class="mb-2">
                            <p>Sub Total: S/ {{ subtotal.toFixed(2) }}</p>
                            <p>Descuento: S/ {{ descuento.toFixed(2) }}</p>
                            <p><strong>Total: S/ {{ total.toFixed(2) }}</strong></p>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-danger me-2" @click="cancelarPedido">Cancelar</button>
                            <button class="btn btn-success" @click="ordenarPedido">Ordenar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script layout:fragment="script">
            new Vue({
                el: "#app",
                data: {
                    busqueda: "",
                    platos: [],
                    pedido: [],
                    nombreCliente: "",
                    numeroMesa: 1,
                    personas: 1,
                    tipoDescuento: "Porcentaje",
                    valorDescuento: 0,
                    descuento: 0
                },
                computed: {
                    platosFiltrados() {
                        const b = this.busqueda.toLowerCase();
                        return this.platos.filter(p =>
                            p.nombre.toLowerCase().includes(b) ||
                                    (p.descripcion && p.descripcion.toLowerCase().includes(b))
                        );
                    },
                    subtotal() {
                        return this.pedido.reduce((s, i) => s + i.precio * i.cantidad, 0);
                    },
                    total() {
                        return this.subtotal - this.descuento;
                    }
                },
                methods: {
                    agregarPlato(plato) {
                        const e = this.pedido.find(x => x.id === plato.id);
                        if (e)
                            e.cantidad++;
                        else
                            this.pedido.push({...plato, cantidad: 1});
                    },
                    quitarPlato(plato) {
                        this.pedido = this.pedido.filter(x => x.id !== plato.id);
                    },
                    aplicarDescuento() {
                        this.descuento = this.tipoDescuento === "Porcentaje"
                                ? this.subtotal * (this.valorDescuento / 100)
                                : this.valorDescuento;
                    },
                    cargarPlatos() {
                        this.$http.get("/api/platos")
                                .then(r => this.platos = r.data.filter(p => p.estado === 'activo'));
                    },
                    ordenarPedido() {
                        const payload = {
                            idRestaurante: 1,
                            idUsuario: 1,
                            numeroMesa: this.numeroMesa,
                            comensal: this.nombreCliente,
                            nPersona: this.personas,
                            subtotal: this.subtotal,
                            descuento: this.descuento,
                            costoFinal: this.total,
                            estadoEntrega: "En preparaci√≥n",
                            estadoPago: "No pagado",
                            platos: this.pedido.map(p => ({
                                    idProducto: p.id,
                                    nombreProducto: p.nombre,
                                    cantidad: p.cantidad,
                                    precioUnitario: p.precio,
                                    subtotal: p.precio * p.cantidad
                                }))
                        };
                        this.$http.post("/api/pedidos", payload)
                                .then(() => window.location.href = "/pedidos")
                                .catch(console.error);
                    },
                    cancelarPedido() {
                        if (confirm("¬øCancelar pedido?")) {
                            this.pedido = [];
                            this.nombreCliente = "";
                            this.numeroMesa = 1;
                            this.personas = 1;
                            this.valorDescuento = 0;
                            this.descuento = 0;
                        }
                    }
                },
                mounted() {
                    this.cargarPlatos();
                }
            });
        </script>
    </body>
</html>